<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>叫貨明細</title>
<!-- 样式保留不动 -->
<style>/* 省略未变动 CSS 原样保留 */</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>叫貨明細</h1>
    <p class="hint">以下為本次訂單資訊：</p>
    <!-- 匯款資訊 -->
    <!-- 表格與操作列保持不變 -->
    <p id="resultLine" class="footline">正在載入資料中…</p>
    <!-- 訂單明細表格 -->
  </div>
</div>
<script>
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/mxd447qyeae62is1m1vsutndp3bqhudf";
const MAKE_BIND_URL = "https://hook.eu2.make.com/xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
const MAKE_TEST_PUSH = "https://hook.eu2.make.com/yyyyyyyyyyyyyyyyyyyyyyyyyyyyyyyy";
const LIFF_ID = "YOUR_LIFF_ID";
const LINE_ADD_FRIEND_URL = "https://lin.ee/RTMwUYu";
const LINE_MSG_DEEPLINK_PREFIX = "line://msg/text/";

const enToStd = {
  order_time:'order_time', order_id:'order_id', email:'email',
  store_name:'store_name', delivery_method:'delivery_method',
  pickup_note:'pickup_note', order_details:'orders',
  shipping:'shipping_fee', total:'total_amount'
};
const zhToStd = {
  "訂單時間":"order_time","訂單編號":"order_id","信箱":"email","分店名稱":"store_name",
  "寄貨方式":"delivery_method","取貨備註":"pickup_note","商品明細":"orders",
  "實際運費":"shipping_fee","總計金額":"total_amount"
};
function decodeQS(s){ try{ return decodeURIComponent(String(s||'').replace(/\+/g,' ')); }catch{ return String(s||''); } }
function setCell(id,val){ const el=document.getElementById(id); const v=(val==null||val==='')?'（空）':String(val); el.textContent=v; el.classList.toggle('muted',v==='（空）'); }
function readParamsStd(){
  const std={}, usp=new URLSearchParams(location.search.startsWith('?') ? location.search.slice(1) : location.search);
  usp.forEach((v,k)=>{
    const key = decodeQS(k).trim();
    const val = decodeQS(v).trim();
    if(key in enToStd) std[enToStd[key]] = val;
    if(key === 'orders' || key === 'order_details') std['orders'] = val;
  });
  usp.forEach((v,k)=>{
    const maybeValue = decodeQS(k).trim(), maybeLabel = decodeQS(v).trim();
    const stdKey = zhToStd[maybeLabel];
    if(stdKey && (std[stdKey]==null || std[stdKey]==='')) std[stdKey] = maybeValue;
  });
  return std;
}
function buildOrderPayload(std){
  return {
    '訂單時間':std.order_time||'','訂單編號':std.order_id||'','信箱':std.email||'','分店名稱':std.store_name||'',
    '寄貨方式':std.delivery_method||'','取貨備註':std.pickup_note||'','商品明細':std.orders||'',
    '實際運費':std.shipping_fee||'','總計金額':std.total_amount||'',
    order_time:std.order_time||'', order_id:std.order_id||'', email:std.email||'', store_name:std.store_name||'',
    delivery_method:std.delivery_method||'', pickup_note:std.pickup_note||'', orders:std.orders||'',
    shipping_fee:std.shipping_fee||'', total_amount:std.total_amount||'',
    _source_url:location.href
  };
}
async function postOrderToMake(payload){
  try{
    await fetch(MAKE_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({__emailjs__:payload})});
    document.getElementById('resultLine').innerHTML='✅ <span class="ok">成功</span>寄通知給總部';
  }catch{
    document.getElementById('resultLine').innerHTML='❌ <span class="bad">失敗</span>寄通知給總部';
  }
}
function buildLineMessage(std,last5){
  const parts=['【匯款後五碼回報】'];
  if(std.order_id) parts.push('訂單編號：'+std.order_id);
  if(std.store_name) parts.push('分店：'+std.store_name);
  if(std.total_amount) parts.push('總金額：'+std.total_amount);
  parts.push('匯款後五碼：'+(last5||''));
  return parts.join('\n');
}
async function openLineAndPaste(text){
  try{ await navigator.clipboard.writeText(text); }catch{
    const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand('copy'); document.body.removeChild(ta);
  }
  const deep = LINE_MSG_DEEPLINK_PREFIX + encodeURIComponent(text);
  try{
    const a=document.createElement('a'); a.href=deep; a.style.display='none'; document.body.appendChild(a); a.click();
    setTimeout(()=>{try{document.body.removeChild(a)}catch{}},1500);
  }catch{}
  setTimeout(()=>{ window.location.href = LINE_ADD_FRIEND_URL; },800);
}
async function handleSendLast5(std){
  let last5 = prompt('請輸入匯款後五碼：',''); if(last5==null) return;
  last5=String(last5).trim();
  if(!/^\d{5}$/.test(last5)){ alert('格式不正確，請輸入 5 位數字。'); return; }
  const msg = buildLineMessage(std,last5); await openLineAndPaste(msg);
}
(function init(){
  const std = readParamsStd();
  window.std = std;
  setCell('order_time',std.order_time);
  setCell('order_id',std.order_id);
  setCell('email',std.email);
  setCell('store_name',std.store_name);
  setCell('delivery_method',std.delivery_method);
  setCell('pickup_note',std.pickup_note);
  setCell('orders',std.orders);
  setCell('shipping_fee',std.shipping_fee);
  setCell('total_amount',std.total_amount);
  document.getElementById('resultLine').innerHTML='✅ 已載入訂單資料，訂單已通知總部';
  const payload = buildOrderPayload(std);
  postOrderToMake(payload);
  document.getElementById('btnSendLast5')?.addEventListener('click', ()=> handleSendLast5(std));
})();
</script>
</body>
</html>
