<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>叫貨明細</title>
<style>
:root{--border:#e5e7eb;--muted:#6b7280;--text:#111827;}
body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;color:var(--text);background:#f8fafc}
.wrap{max-width:840px;margin:48px auto;padding:0 16px}
.card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:28px}
h1{margin:0 0 20px;text-align:center;letter-spacing:.12em;font-weight:800;font-size:28px}
.hint{color:var(--muted);margin:0 0 14px}
.table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff}
.table th,.table td{border-bottom:1px solid var(--border);padding:14px 16px;vertical-align:top;word-break:break-word}
.table th{width:28%;background:#f9fafb;text-align:left;color:#111827;font-weight:700}
.muted{color:var(--muted)}
.prewrap{white-space:pre-wrap}
.footline{margin-top:14px;border-left:4px solid #3b82f6;padding-left:10px;color:var(--muted)}
.ok{color:#059669}.bad{color:#b91c1c}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>叫貨明細</h1>
    <p class="hint">以下為本次訂單資訊：</p>
    <table class="table">
      <tbody>
        <tr><th>訂單時間</th><td id="order_time"     class="muted">（空）</td></tr>
        <tr><th>訂單編號</th><td id="order_id"       class="muted">（空）</td></tr>
        <tr><th>信箱</th><td     id="email"          class="muted">（空）</td></tr>
        <tr><th>分店名稱</th><td id="store_name"     class="muted">（空）</td></tr>
        <tr><th>寄貨方式</th><td id="delivery_method"class="muted">（空）</td></tr>
        <tr><th>取貨備註</th><td id="pickup_note"    class="muted">（空）</td></tr>
        <tr><th>商品明細</th><td id="orders"         class="muted prewrap">（空）</td></tr>
        <tr><th>實際運費</th><td id="shipping_fee"   class="muted">（空）</td></tr>
        <tr><th>總計金額</th><td id="total_amount"   class="muted">（空）</td></tr>
      </tbody>
    </table>
    <p id="resultLine" class="footline">正在將通知送出總部…</p>
  </div>
</div>

<script>
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/mxd447qyeae62is1m1vsutndp3bqhudf";

// 你提供的「Glide 英文鍵」→ 內部標準鍵
const enToStd = {
  order_time: 'order_time',
  order_id: 'order_id',
  email: 'email',
  store_name: 'store_name',
  delivery_method: 'delivery_method',
  pickup_note: 'pickup_note',
  order_details: 'orders',
  shipping: 'shipping_fee',
  total: 'total_amount'
};

// 中文欄位名 → 內部標準鍵（處理左右顛倒）
const zhToStd = {
  "訂單時間": "order_time",
  "訂單編號": "order_id",
  "信箱": "email",
  "分店名稱": "store_name",
  "寄貨方式": "delivery_method",
  "取貨備註": "pickup_note",
  "商品明細": "orders",
  "實際運費": "shipping_fee",
  "總計金額": "total_amount"
};

function decode(s){
  try { return decodeURIComponent(String(s||'').replace(/\+/g,' ')); }
  catch { return String(s||''); }
}

// 同時支援：1) 正常 key=value（英文鍵） 2) 左右顛倒（值=中文欄位名）
function readParamsStd(){
  const std = {};
  const usp = new URLSearchParams(location.search.startsWith('?') ? location.search.slice(1) : location.search);

  usp.forEach((v,k) => {
    const key = decode(k).trim();
    const val = decode(v).trim();

    // 情況 1：正常 key=value（英文鍵）
    if (key in enToStd) {
      std[ enToStd[key] ] = val;
      return;
    }

    // 情況 2：左右顛倒（值=中文欄位名），key 是「實際數值」，val 是「中文欄位名」
    if (zhToStd[val]) {
      std[ zhToStd[val] ] = key; // 注意：用 key 當值
      return;
    }
  });

  return std;
}

function setCell(id, val){
  const el = document.getElementById(id);
  el.textContent = val ? String(val) : '（空）';
  el.classList.toggle('muted', !val);
}

function buildPayload(std){
  return {
    // 中文鍵
    '訂單時間': std.order_time || '',
    '訂單編號': std.order_id || '',
    '信箱': std.email || '',
    '分店名稱': std.store_name || '',
    '寄貨方式': std.delivery_method || '',
    '取貨備註': std.pickup_note || '',
    '商品明細': std.orders || '',
    '實際運費': std.shipping_fee || '',
    '總計金額': std.total_amount || '',
    // 英文鍵（同時帶上，Make 端好對應）
    order_time: std.order_time || '',
    order_id: std.order_id || '',
    email: std.email || '',
    store_name: std.store_name || '',
    delivery_method: std.delivery_method || '',
    pickup_note: std.pickup_note || '',
    orders: std.orders || '',
    shipping_fee: std.shipping_fee || '',
    total_amount: std.total_amount || '',
    _source_url: location.href
  };
}

async function postToMake(payload){
  try{
    await fetch(MAKE_WEBHOOK_URL, {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ __emailjs__: payload })
    });
    document.getElementById('resultLine').innerHTML = '✅ <span class="ok">成功</span>寄通知給總部';
  }catch(_){
    document.getElementById('resultLine').innerHTML = '❌ <span class="bad">失敗</span>寄通知給總部';
  }
}

(function init(){
  const std = readParamsStd();

  // 顯示在表格（與欄位 id 對應）
  setCell('order_time',   std.order_time);
  setCell('order_id',     std.order_id);
  setCell('email',        std.email);
  setCell('store_name',   std.store_name);
  setCell('delivery_method', std.delivery_method);
  setCell('pickup_note',  std.pickup_note);
  setCell('orders',       std.orders);
  setCell('shipping_fee', std.shipping_fee);
  setCell('total_amount', std.total_amount);

  // 背景送到 Make（隱藏式）
  postToMake(buildPayload(std));
})();
</script>
</body>
</html>
