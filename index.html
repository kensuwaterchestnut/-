<!DOCTYPE html>
<html lang="zh-Hant">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>叫貨明細</title>
<style>
:root{--border:#e5e7eb;--muted:#6b7280;--text:#111827;--ok:#059669;--bad:#b91c1c;--brand:#3b82f6;--bg:#f8fafc;--surface:#fff}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0;
  font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;
  color:var(--text);background:var(--bg);
  -webkit-tap-highlight-color:transparent;
  padding-top:env(safe-area-inset-top);padding-bottom:env(safe-area-inset-bottom)
}
.wrap{max-width:840px;margin:32px auto;padding:0 12px}
.card{background:var(--surface);border:1px solid var(--border);border-radius:14px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:20px}
h1{margin:0 0 14px;text-align:center;letter-spacing:.08em;font-weight:800;font-size:22px}
.hint{color:var(--muted);margin:0 0 12px;font-size:14px}

/* Mobile-first 表格：每列上下堆疊 */
.table{width:100%;border-collapse:collapse;table-layout:auto;border:1px solid var(--border);border-radius:10px;overflow:hidden;background:var(--surface)}
.table tbody tr{display:block;border-bottom:1px solid var(--border);padding:10px 12px}
.table tbody tr:last-child{border-bottom:0}
.table th,.table td{display:block;padding:0;vertical-align:top;word-break:break-word}
.table th{margin:0 0 6px;color:#111827;font-weight:700;font-size:13px}
.table td{font-size:15px;line-height:1.6}
.muted{color:var(--muted)}
.prewrap{white-space:pre-wrap}

/* 狀態與提示 */
.footline{margin-top:12px;border-left:4px solid var(--brand);padding:10px 12px;color:var(--muted);border-radius:8px;background:#f8fbff;font-size:14px}
.ok{color:var(--ok)}.bad{color:var(--bad)}
.notice{margin-top:16px;background:#f0f9ff;border:1px solid #dbeafe;border-radius:12px;padding:14px}
.warn{background:#fff7ed;border-color:#ffedd5}
.small{font-size:14px}
code{background:#f3f4f6;border:1px solid var(--border);padding:2px 6px;border-radius:6px}

/* 區塊 */
.bank{margin-top:12px}
.bank h3{margin:0 0 8px;font-size:18px}
.row{display:flex;gap:10px;flex-direction:column}
.kv{display:flex;align-items:center;justify-content:space-between;gap:8px;background:#f9fafb;border:1px solid var(--border);padding:12px;border-radius:12px}
.kv b{font-size:14px}

/* 按鈕 */
.btn{cursor:pointer;border:1px solid var(--border);background:#fff;border-radius:10px;padding:10px 14px;font-size:15px;touch-action:manipulation;min-width:120px}
.btn:active{transform:translateY(1px)}
.btn-primary{background:#2563eb;border-color:#2563eb;color:#fff}

/* 置頂固定操作列 */
.sticky-actions{
  position:sticky; top:0; z-index:30;
  margin:12px -10px 0;
  padding:10px;
  background:#ffffffF2; backdrop-filter:blur(6px);
  border:1px solid var(--border); border-left:0; border-right:0;
  display:flex; gap:10px; flex-wrap:wrap;
}
.sticky-actions .btn{flex:1}

@media (min-width:640px){
  .wrap{margin:48px auto;padding:0 16px}
  .card{padding:28px}
  h1{font-size:28px}
  .table{table-layout:fixed}
  .table tbody tr{display:table-row;padding:0}
  .table th,.table td{display:table-cell;padding:14px 16px;border-bottom:1px solid var(--border)}
  .table th{width:28%;background:#f9fafb}
  .table tbody tr:last-child th,.table tbody tr:last-child td{border-bottom:0}
  .row{flex-direction:row}
  .sticky-actions{margin-left:-16px;margin-right:-16px}
}

/* 商 品 明 細：數字清單（畫面用） */
.orders-list{margin:0;padding-left:1.5em;list-style:decimal;list-style-position:outside}
.orders-list li{margin:3px 0;line-height:1.6}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>叫貨明細</h1>
    <p class="hint">以下為本次訂單資訊：</p>

    <!-- 匯款資訊（上方） -->
    <div class="notice bank">
      <h3>匯款資訊</h3>
      <div class="row">
        <div class="kv" aria-label="銀行代號"><b>銀行代號</b><span id="bank_code_txt">824（連線銀行）</span></div>
        <div class="kv" aria-label="銀行帳號">
          <b>銀行帳號</b><span id="bank_acct_txt" style="font-variant-numeric:tabular-nums">111013782313</span>
          <button id="copyBtn" class="btn" type="button">複製帳號</button>
        </div>
      </div>
      <ul class="small" style="margin:10px 0 0 18px;line-height:1.7">
        <li>下單後，<b>收到款項</b>進行出貨（約 <b>3–5 個工作天</b>）。</li>
        <li>如需開立發票/收據，需加收<b>營業稅 5%</b>。</li>
        <li>匯款後請提供<b>後五碼</b>傳送至總部官方帳號。</li>
      </ul>
    </div>

    <!-- 置頂固定操作列：只留「上傳後五碼（開啟 LINE）」 -->
    <div class="sticky-actions">
      <button id="btnSendLast5" class="btn btn-primary" type="button">上傳後五碼（開啟 LINE）</button>
    </div>

    <div id="guardMsg" class="notice warn small" style="display:none;"></div>
    <p id="resultLine" class="footline">正在檢查必要欄位…</p>

    <!-- 訂單明細表格 -->
    <table class="table">
      <tbody>
        <tr><th>訂單時間</th><td id="order_time"     class="muted">（空）</td></tr>
        <tr><th>訂單編號</th><td id="order_id"       class="muted">（空）</td></tr>
        <tr><th>信箱</th><td     id="email"          class="muted">（空）</td></tr>
        <tr><th>分店名稱</th><td id="store_name"     class="muted">（空）</td></tr>
        <tr><th>寄貨方式</th><td id="delivery_method"class="muted">（空）</td></tr>
        <tr><th>取貨備註</th><td id="pickup_note"    class="muted">（空）</td></tr>
        <tr><th>商品明細</th><td id="orders"         class="muted prewrap">（空）</td></tr>
        <tr><th>實際運費</th><td id="shipping_fee"   class="muted">（空）</td></tr>
        <tr><th>總計金額</th><td id="total_amount"   class="muted">（空）</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script>
// ====== 你只需要改這裡（Make 設定）======
const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/mxd447qyeae62is1m1vsutndp3bqhudf";
// ====== LINE 官方帳號連結（加好友 / 後備跳轉）======
const LINE_ADD_FRIEND_URL = "https://lin.ee/RTMwUYu";
// ===============================================

// 英文鍵 → 內部標準鍵
const enToStd = {
  order_time:'order_time', order_id:'order_id', email:'email',
  store_name:'store_name', delivery_method:'delivery_method',
  pickup_note:'pickup_note', order_details:'orders',
  shipping:'shipping_fee', total:'total_amount'
};
// 中文欄位名 → 內部標準鍵
const zhToStd = {
  "訂單時間":"order_time","訂單編號":"order_id","信箱":"email","分店名稱":"store_name",
  "寄貨方式":"delivery_method","取貨備註":"pickup_note","商品明細":"orders",
  "實際運費":"shipping_fee","總計金額":"total_amount"
};

// ------ 工具（保留你原本，另外新增更強的解析） ------
function decodeQS(s){ try{ return decodeURIComponent(String(s||'').replace(/\+/g,' ')); }catch{ return String(s||''); } }
function setCell(id,val){ const el=document.getElementById(id); const v=(val==null||val==='')?'（空）':String(val); el.textContent=v; el.classList.toggle('muted',v==='（空）'); }
function isValidEmail(s){ return !!(s && /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(s.trim())); }
function showGuard(html){ const box=document.getElementById('guardMsg'); box.style.display='block'; box.innerHTML=html; }
function hideGuard(){ const box=document.getElementById('guardMsg'); box.style.display='none'; box.innerHTML=''; }
function setCellHTML(id, html){ const el=document.getElementById(id); const ok = html && String(html).trim()!==''; if(ok){ el.innerHTML=html; el.classList.remove('muted'); } else { el.textContent='（空）'; el.classList.add('muted'); } }
function escapeHTML(s){ return String(s||'').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

// 兼容取得 query（支援 ? 與 #；也容忍前面多了 ?&）
function getQueryString(){
  let raw = '';
  if (location.search && location.search.startsWith('?')) raw = location.search.slice(1);
  if (!raw && location.hash){
    const h = location.hash;
    const qPos = h.indexOf('?');
    raw = (qPos >= 0) ? h.slice(qPos+1) : (h.startsWith('#') ? h.slice(1) : h);
  }
  return String(raw||'').replace(/^\?*&+/, '').trim();
}
// 安全解碼（容忍未編碼空白與全形字）
function safeDecode(str){
  try { return decodeURIComponent(String(str||'').replace(/\+/g,' ')); }
  catch { return String(str||'').replace(/\+/g,' '); }
}

// ★ 強化版解析：同時支援
//   a) 英文鍵=值 （order_time=2025…）
//   b) 值=中文鍵（2025…=訂單時間）← 你的實際情況
//   c) 中文鍵=值（訂單時間=2025…）
function readParamsStd(){
  const std = {};
  const raw = getQueryString();
  if (!raw) return std;

  const pairs = raw.split('&').filter(Boolean);
  for (const pair of pairs){
    const eq = pair.lastIndexOf('=');
    let left = pair, right = '';
    if (eq >= 0){ left = pair.slice(0, eq); right = pair.slice(eq+1); }

    const L = safeDecode(left).trim();
    const R = safeDecode(right).trim();
    if (!L && !R) continue;

    if (L in enToStd && R !== ''){                       // 英文鍵=值
      const key=enToStd[L]; if (std[key]==null||std[key]==='') std[key]=R; continue;
    }
    if (L in zhToStd && R !== ''){                        // 中文鍵=值
      const key=zhToStd[L]; if (std[key]==null||std[key]==='') std[key]=R; continue;
    }
    if (R in zhToStd && L !== ''){                        // 值=中文鍵（顛倒）
      const key=zhToStd[R]; if (std[key]==null||std[key]==='') std[key]=L; continue;
    }
  }
  return std;
}

/* ===== 商品明細解析（支援 x/X/×；標籤可在前或後；避免重複） ===== */
function parseOrders(raw){
  let t = String(raw||'').replace(/\s+/g,' ').replace(/\s*[xX×]\s*$/,'').trim();
  const items=[], re=/(?:[（(]\s*([^（）)]+?)\s*[）)])?\s*(.+?)\s*[xX×]\s*(\d+)(?:\s*[（(]\s*([^（）)]+?)\s*[）)])?/gx;
  let m;
  while((m=re.exec(t))){
    let lead=(m[1]||'').trim(), name=(m[2]||'').trim(), qty=(m[3]||'').trim(), trail=(m[4]||'').trim();
    name=name.replace(/^\s*[（(]\s*([^（）)]+?)\s*[）)]\s*/,(_,tg)=>{ if(!lead&&!trail) lead=(tg||'').trim(); return ''; }).trim();
    const tag = lead || trail || '';
    name=name.replace(/\s*[xX×]\s*$/,'');
    items.push({name,qty,tag});
  }
  if(items.length===0 && t) items.push({name:t,qty:'',tag:''});
  return items;
}
function formatOrdersHTML(raw){
  const items=parseOrders(raw);
  if(!items.length) return '';
  const lis = items.map(it=>{
    const tag = it.tag ? `（${escapeHTML(it.tag)}）` : '';
    return `<li>${tag}${escapeHTML(it.name)} × ${escapeHTML(it.qty)}</li>`;
  }).join('');
  return `<ol class="orders-list">${lis}</ol>`;
}
function formatOrdersText(raw){
  const items=parseOrders(raw);
  return items.map((it,i)=>`${i+1}. ${it.tag?`（${it.tag}）`:''}${it.name} × ${it.qty}`).join('\n');
}

// 組訂單 payload（原樣）
function buildOrderPayload(std){
  return {
    '訂單時間':std.order_time||'','訂單編號':std.order_id||'','信箱':std.email||'','分店名稱':std.store_name||'',
    '寄貨方式':std.delivery_method||'','取貨備註':std.pickup_note||'','商品明細':std.orders||'',
    '實際運費':std.shipping_fee||'','總計金額':std.total_amount||'',
    order_time:std.order_time||'', order_id:std.order_id||'', email:std.email||'', store_name:std.store_name||'',
    delivery_method:std.delivery_method||'', pickup_note:std.pickup_note||'', orders:std.orders||'',
    shipping_fee:std.shipping_fee||'', total_amount:std.total_amount||'',
    _source_url:location.href
  };
}

// 貼到 LINE（商品明細→多行數字條列）
function buildLineText(std){
  const lines = [
    '【匯款後五碼回報】',
    `訂單時間：${std.order_time||''}`,
    `訂單編號：${std.order_id||''}`,
    `分店名稱：${std.store_name||''}`,
    `信箱：${std.email||''}`,
    `寄貨方式：${std.delivery_method||''}`,
    `取貨備註：${std.pickup_note||''}`,
    '商品明細：',
    formatOrdersText(std.orders||''),
    '',
    `實際運費：${std.shipping_fee||''}`,
    `總計金額：${std.total_amount||''}`,
    `匯款後五碼：`
  ];
  return lines.join('\n');
}

// 開啟 LINE 並貼上
async function openLineAndPaste(text){
  try{ await navigator.clipboard.writeText(text); }
  catch{ const ta=document.createElement('textarea'); ta.value=text; document.body.appendChild(ta); ta.select(); document.execCommand('copy'); ta.remove(); }
  alert('已複製訂單明細。\n將為你開啟 LINE，請貼上並補上「匯款後五碼」。');
  const deep = "line://msg/text/" + encodeURIComponent(text);
  try{ const a=document.createElement('a'); a.href=deep; a.style.display='none'; document.body.appendChild(a); a.click(); setTimeout(()=>a.remove(),1500);}catch{}
  setTimeout(()=>{ window.location.href = LINE_ADD_FRIEND_URL; },800);
}

// 背景送 Make
async function postOrderToMake(payload){
  try{
    await fetch(MAKE_WEBHOOK_URL,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({__emailjs__:payload})});
    document.getElementById('resultLine').innerHTML='✅ <span class="ok">成功</span>寄通知給總部';
  }catch{ document.getElementById('resultLine').innerHTML='❌ <span class="bad">失敗</span>寄通知給總部'; }
}

// 啟動
(function init(){
  const std = readParamsStd();  // ← 這版能吃你提供的網址模板最終產生的顛倒格式
  window.std = std;

  // 表格
  setCell('order_time',std.order_time); setCell('order_id',std.order_id); setCell('email',std.email);
  setCell('store_name',std.store_name); setCell('delivery_method',std.delivery_method);
  setCell('pickup_note',std.pickup_note);
  setCellHTML('orders', formatOrdersHTML(std.orders||''));  // 商品明細→清單
  setCell('shipping_fee',std.shipping_fee); setCell('total_amount',std.total_amount);

  // 通知總部（需要有效 Email）
  if(!isValidEmail(std.email)){
    showGuard('未檢測到有效的 <b>信箱</b>，本次不會通知總部（避免寄出空白/錯誤資料）。<br>請確認 Glide 帶入參數包含 <code>email</code> 或顛倒格式中含「信箱」。');
    document.getElementById('resultLine').innerHTML='⛔ 已停止通知：缺少有效信箱。';
  }else{
    hideGuard();
    document.getElementById('resultLine').innerHTML='已檢核通過，正在通知總部…';
    postOrderToMake(buildOrderPayload(std));
  }

  // 事件
  document.getElementById('copyBtn')?.addEventListener('click', async (e)=>{
    const btn=e.currentTarget; const acct=document.getElementById('bank_acct_txt').textContent.trim();
    try{ await navigator.clipboard.writeText(acct); btn.textContent='已複製！'; setTimeout(()=> btn.textContent='複製帳號',1200);}catch{}
  });
  document.getElementById('btnSendLast5')?.addEventListener('click', ()=>{ openLineAndPaste(buildLineText(std)); });
})();
</script>
</body>
</html>
