<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>叫貨明細</title>
  <style>
    :root{--border:#e5e7eb;--muted:#6b7280;--text:#111827;}
    *{box-sizing:border-box}
    body{margin:0;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Noto Sans TC","Helvetica Neue",Arial,sans-serif;color:var(--text);background:#f8fafc}
    .wrap{max-width:840px;margin:48px auto;padding:0 16px}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;box-shadow:0 6px 16px rgba(0,0,0,.06);padding:28px}
    h1{margin:0 0 20px;text-align:center;letter-spacing:.12em;font-weight:800;font-size:28px}
    .hint{color:var(--muted);margin:0 0 14px}
    .table{width:100%;border-collapse:collapse;table-layout:fixed;border:1px solid var(--border);border-radius:8px;overflow:hidden;background:#fff}
    .table th,.table td{border-bottom:1px solid var(--border);padding:14px 16px;vertical-align:top;word-break:break-word}
    .table th{width:28%;background:#f9fafb;text-align:left;color:#111827;font-weight:700}
    .muted{color:var(--muted)}
    .prewrap{white-space:pre-wrap}
    .footline{margin-top:14px;border-left:4px solid #3b82f6;padding-left:10px;color:var(--muted)}
    .ok{color:#059669}.bad{color:#b91c1c}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>叫貨明細</h1>
      <p class="hint">此頁會讀取網址列參數並自動送到 Make Webhook。</p>

      <table class="table">
        <tbody>
          <tr><th>訂單時間</th><td id="order_time"     class="muted">（空）</td></tr>
          <tr><th>訂單編號</th><td id="order_id"       class="muted">（空）</td></tr>
          <tr><th>信箱</th><td     id="email"          class="muted">（空）</td></tr>
          <tr><th>分店名稱</th><td id="store_name"     class="muted">（空）</td></tr>
          <tr><th>寄貨方式</th><td id="delivery_method"class="muted">（空）</td></tr>
          <tr><th>取貨備註</th><td id="pickup_note"    class="muted">（空）</td></tr>
          <tr><th>商品明細</th><td id="orders"         class="muted prewrap">（空）</td></tr>
          <tr><th>實際運費</th><td id="shipping_fee"   class="muted">（空）</td></tr>
          <tr><th>總計金額</th><td id="total_amount"   class="muted">（空）</td></tr>
        </tbody>
      </table>

      <p id="resultLine" class="footline">正在將通知送出總部…</p>
    </div>
  </div>

  <script>
    // 你的 Make Webhook
    const MAKE_WEBHOOK_URL = "https://hook.eu2.make.com/mxd447qyeae62is1m1vsutndp3bqhudf";

    // 欄位別名（英/中）→ 標準欄位
    const aliasToStd = new Map([
      ['order_time','order_time'], ['time','order_time'], ['t','order_time'], ['訂單時間','order_time'],
      ['order_id','order_id'], ['id','order_id'], ['訂單編號','order_id'],
      ['email','email'], ['mail','email'], ['信箱','email'],
      ['store','store_name'], ['store_name','store_name'], ['branch','store_name'], ['分店名稱','store_name'],
      ['delivery','delivery_method'], ['delivery_method','delivery_method'], ['ship','delivery_method'], ['寄貨方式','delivery_method'],
      ['pickup_note','pickup_note'], ['note','pickup_note'], ['備註','pickup_note'], ['取貨備註','pickup_note'],
      ['orders','orders'], ['order_details','orders'], ['items','orders'], ['商品明細','orders'],
      ['shipping','shipping_fee'], ['shipping_fee','shipping_fee'], ['運費','shipping_fee'], ['實際運費','shipping_fee'],
      ['total','total_amount'], ['total_amount','total_amount'], ['sum','total_amount'], ['總計金額','total_amount'],
    ]);

    // 中文標籤 → 標準欄位（用於顛倒式）
    const zhLabelToStd = new Map([
      ['訂單時間','order_time'],
      ['訂單編號','order_id'],
      ['信箱','email'],
      ['分店名稱','store_name'],
      ['寄貨方式','delivery_method'],
      ['取貨備註','pickup_note'],
      ['商品明細','orders'],
      ['實際運費','shipping_fee'],
      ['總計金額','total_amount'],
    ]);

    const safeDecode = (s)=> {
      try { return decodeURIComponent(String(s||'').replace(/\+/g,' ')); }
      catch { return String(s||''); }
    };

    function setCell(id, val){
      const el = document.getElementById(id);
      if (!el) return;
      el.textContent = val ? String(val) : '（空）';
      el.classList.toggle('muted', !val);
    }

    // 讀取並同時支援：1) 正常 key=value 2) 顛倒 值=中文欄位名
    function readAndNormalizeParams(){
      const raw = location.search.startsWith('?') ? location.search.slice(1) : location.search;
      const pairs = [];
      try{
        const usp = new URLSearchParams(raw);
        usp.forEach((v,k)=> pairs.push([safeDecode(k), safeDecode(v)]));
      }catch(e){ /* 忽略解析失敗，保持 pairs 空陣列 */ }

      const std = {};
      // 1) 正常 key=value
      for(const [k,v] of pairs){
        const keyStd = aliasToStd.get(k.trim());
        if (keyStd) std[keyStd] = (v||'').trim();
      }
      // 2) 顛倒 值=中文欄位名（只有當尚未被填入時才使用）
      for(const [maybeValue, maybeLabel] of pairs){
        const keyStd = zhLabelToStd.get((maybeLabel||'').trim());
        if (keyStd && (std[keyStd] == null)){
          std[keyStd] = (maybeValue||'').trim();
        }
      }
      return std;
    }

    function buildPayload(std){
      return {
        // 中文鍵（方便在 Make 裡直接用）
        '訂單時間': std.order_time || '',
        '訂單編號': std.order_id || '',
        '信箱': std.email || '',
        '分店名稱': std.store_name || '',
        '寄貨方式': std.delivery_method || '',
        '取貨備註': std.pickup_note || '',
        '商品明細': std.orders || '',
        '實際運費': std.shipping_fee || '',
        '總計金額': std.total_amount || '',
        // 英文鍵（備用）
        order_time: std.order_time || '',
        order_id: std.order_id || '',
        email: std.email || '',
        store_name: std.store_name || '',
        delivery_method: std.delivery_method || '',
        pickup_note: std.pickup_note || '',
        orders: std.orders || '',
        shipping_fee: std.shipping_fee || '',
        total_amount: std.total_amount || '',
        // 來源網址
        _source_url: location.href
      };
    }

    async function postToMake(emailJsPayload){
      if (!MAKE_WEBHOOK_URL) return false;
      try{
        const res = await fetch(MAKE_WEBHOOK_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ __emailjs__: emailJsPayload })
        });
        return true; // 即使 CORS 阻擋回應，Make 仍會收到
      }catch(_){
        return false;
      }
    }

    (async ()=>{
      const std = readAndNormalizeParams();

      // 顯示
      setCell('order_time',   std.order_time);
      setCell('order_id',     std.order_id);
      setCell('email',        std.email);
      setCell('store_name',   std.store_name);
      setCell('delivery_method', std.delivery_method);
      setCell('pickup_note',  std.pickup_note);
      setCell('orders',       std.orders);
      setCell('shipping_fee', std.shipping_fee);
      setCell('total_amount', std.total_amount);

      // 送 Make
      const ok = await postToMake(buildPayload(std));
      const line = document.getElementById('resultLine');
      line.innerHTML = ok
        ? '✅ <span class="ok">成功</span>寄通知給總部，明細表請自行留存。'
        : '❌ <span class="bad">失敗</span>寄通知給總部，請稍後重試或聯絡管理員。';
    })();
  </script>
</body>
</html>
